#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# shutsujin_teams.sh â€” ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ å‡ºé™£ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä»˜ãï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ã‚ªãƒªã‚¸ãƒŠãƒ«ç‰ˆ shutsujin_departure.sh ã¨åŒã˜ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‚
# å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç‹¬ç«‹ Claude Code ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦ tmux ãƒšã‚¤ãƒ³ã§å‹•ä½œã€‚
# é€šä¿¡ã¯ inbox_write.sh (YAML mailbox)ã€å›å¾©ã¯ inbox_watcher.shã€‚
# ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã¯åˆ¥ Terminal.app ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è‡ªå‹•è¡¨ç¤ºã€‚
#
# ä½¿ç”¨æ–¹æ³•:
#   ./shutsujin_teams.sh              # ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å…¨è»ã‚’èµ·å‹•
#   ./shutsujin_teams.sh -c           # ã‚­ãƒ¥ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦èµ·å‹•ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
#   ./shutsujin_teams.sh -k           # æ±ºæˆ¦ã®é™£ï¼ˆå…¨è¶³è»½ã‚’Opusã§èµ·å‹•ï¼‰
#   ./shutsujin_teams.sh -s           # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã¿ï¼ˆClaudeèµ·å‹•ãªã—ï¼‰
#   ./shutsujin_teams.sh -S           # ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰
#   ./shutsujin_teams.sh -h           # ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¨€èªãƒ»ã‚·ã‚§ãƒ«è¨­å®šèª­ã¿å–ã‚Š
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
LANG_SETTING="ja"
if [ -f "./config/settings.yaml" ]; then
    LANG_SETTING=$(grep "^language:" ./config/settings.yaml 2>/dev/null | awk '{print $2}' || echo "ja")
fi

SHELL_SETTING="bash"
if [ -f "./config/settings.yaml" ]; then
    SHELL_SETTING=$(grep "^shell:" ./config/settings.yaml 2>/dev/null | awk '{print $2}' || echo "bash")
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Python venv ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒã‚§ãƒƒã‚¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
VENV_DIR="$SCRIPT_DIR/.venv"
if [ ! -f "$VENV_DIR/bin/python3" ] || ! "$VENV_DIR/bin/python3" -c "import yaml" 2>/dev/null; then
    echo -e "\033[1;33mã€å ±ã€‘\033[0m Python venv ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
    if command -v python3 &>/dev/null; then
        # å£Šã‚ŒãŸ venv ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å†ä½œæˆ
        rm -rf "$VENV_DIR"
        # Dropboxå¯¾å¿œ: symlink ãŒä½¿ãˆãªã„å ´åˆã¯ --copies + Homebrew Python ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        python3 -m venv "$VENV_DIR" 2>/dev/null || \
        python3 -m venv --copies "$VENV_DIR" 2>/dev/null || \
        /opt/homebrew/bin/python3 -m venv --copies "$VENV_DIR" 2>/dev/null || \
        /opt/homebrew/bin/python3 -m venv "$VENV_DIR" 2>/dev/null || {
            echo -e "\033[1;31mã€ERRORã€‘\033[0m python3 -m venv ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            exit 1
        }
        "$VENV_DIR/bin/pip" install -r "$SCRIPT_DIR/requirements.txt" -q 2>/dev/null || {
            echo -e "\033[1;31mã€ERRORã€‘\033[0m pip install ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            exit 1
        }
        echo -e "\033[1;32mã€æˆã€‘\033[0m Python venv ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
    else
        echo -e "\033[1;31mã€ERRORã€‘\033[0m python3 ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚first_setup.sh ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CLI Adapterèª­ã¿è¾¼ã¿ï¼ˆMulti-CLI Supportï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ -f "$SCRIPT_DIR/lib/cli_adapter.sh" ]; then
    source "$SCRIPT_DIR/lib/cli_adapter.sh"
    CLI_ADAPTER_LOADED=true
else
    CLI_ADAPTER_LOADED=false
fi

# è¶³è»½IDãƒªã‚¹ãƒˆã¨äººæ•°ã‚’å‹•çš„ã«å–å¾—
if [ "$CLI_ADAPTER_LOADED" = true ]; then
    _ASHIGARU_IDS_STR=$(get_ashigaru_ids)
else
    _ASHIGARU_IDS_STR="ashigaru1 ashigaru2 ashigaru3 ashigaru4 ashigaru5 ashigaru6 ashigaru7"
fi
_ASHIGARU_COUNT=$(echo "$_ASHIGARU_IDS_STR" | wc -w | tr -d ' ')

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è‰²ä»˜ããƒ­ã‚°é–¢æ•°ï¼ˆæˆ¦å›½é¢¨ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
log_info() {
    echo -e "\033[1;33mã€å ±ã€‘\033[0m $1"
}

log_success() {
    echo -e "\033[1;32mã€æˆã€‘\033[0m $1"
}

log_war() {
    echo -e "\033[1;31mã€æˆ¦ã€‘\033[0m $1"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•°ï¼ˆbash/zshå¯¾å¿œï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
generate_prompt() {
    local label="$1"
    local color="$2"
    local shell_type="$3"

    if [ "$shell_type" == "zsh" ]; then
        echo "(%F{${color}}%B${label}%b%f) %F{green}%B%~%b%f%# "
    else
        local color_code
        case "$color" in
            red)     color_code="1;31" ;;
            green)   color_code="1;32" ;;
            yellow)  color_code="1;33" ;;
            blue)    color_code="1;34" ;;
            magenta) color_code="1;35" ;;
            cyan)    color_code="1;36" ;;
            *)       color_code="1;37" ;;
        esac
        echo "(\[\033[${color_code}m\]${label}\[\033[0m\]) \[\033[1;32m\]\w\[\033[0m\]\$ "
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MODEL="opus"
SETUP_ONLY=false
CLEAN_MODE=false
KESSEN_MODE=false
SHOGUN_NO_THINKING=false
SILENT_MODE=false
SHELL_OVERRIDE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --model)
            MODEL="$2"
            shift 2
            ;;
        --dangerously-skip-permissions)
            # å¸¸ã«æœ‰åŠ¹ï¼ˆç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ã¯å…¨ã¦ --dangerously-skip-permissions ã§èµ·å‹•ï¼‰
            shift
            ;;
        -c|--clean)
            CLEAN_MODE=true
            shift
            ;;
        -k|--kessen)
            KESSEN_MODE=true
            shift
            ;;
        -s|--setup-only)
            SETUP_ONLY=true
            shift
            ;;
        -S|--silent)
            SILENT_MODE=true
            shift
            ;;
        --shogun-no-thinking)
            SHOGUN_NO_THINKING=true
            shift
            ;;
        -shell|--shell)
            if [[ -n "$2" && "$2" != -* ]]; then
                SHELL_OVERRIDE="$2"
                shift 2
            else
                echo "ã‚¨ãƒ©ãƒ¼: -shell ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯ bash ã¾ãŸã¯ zsh ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"
                exit 1
            fi
            ;;
        -h|--help)
            echo ""
            echo "ğŸ¯ ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ å‡ºé™£ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä»˜ãï¼‰"
            echo ""
            echo "ä½¿ç”¨æ–¹æ³•: ./shutsujin_teams.sh [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
            echo ""
            echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
            echo "  -c, --clean         ã‚­ãƒ¥ãƒ¼ã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦èµ·å‹•ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰"
            echo "                      æœªæŒ‡å®šæ™‚ã¯å‰å›ã®çŠ¶æ…‹ã‚’ç¶­æŒã—ã¦èµ·å‹•"
            echo "  -k, --kessen        æ±ºæˆ¦ã®é™£ï¼ˆå…¨è¶³è»½ã‚’Opusã§èµ·å‹•ï¼‰"
            echo "                      æœªæŒ‡å®šæ™‚ã¯å¹³æ™‚ã®é™£ï¼ˆè¶³è»½1-7=Sonnet, è»å¸«=Opusï¼‰"
            echo "  -s, --setup-only    ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã¿ï¼ˆClaudeèµ·å‹•ãªã—ï¼‰"
            echo "  -S, --silent        ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆechoè¡¨ç¤ºãªã—ãƒ»APIç¯€ç´„ï¼‰"
            echo "  --model MODEL       å°†è»ã®ãƒ¢ãƒ‡ãƒ«æŒ‡å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: opusï¼‰"
            echo "  --shogun-no-thinking  å°†è»ã®thinkingã‚’ç„¡åŠ¹åŒ–ï¼ˆä¸­ç¶™ç‰¹åŒ–ï¼‰"
            echo "  --dangerously-skip-permissions  æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¹ã‚­ãƒƒãƒ—"
            echo "  -shell, --shell SH  ã‚·ã‚§ãƒ«ã‚’æŒ‡å®šï¼ˆbash ã¾ãŸã¯ zshï¼‰"
            echo "  -h, --help          ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            echo ""
            echo "ä»•çµ„ã¿ï¼ˆç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ + mailboxï¼‰:"
            echo "  1. shogun-teams ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆå°†è»1åï¼‰ã‚’ä½œæˆ"
            echo "  2. multiagent-teams ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ3Ã—3 = 9ãƒšã‚¤ãƒ³ï¼‰ã‚’ä½œæˆ"
            echo "  3. å„ãƒšã‚¤ãƒ³ã§ç‹¬ç«‹ Claude Code ãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•"
            echo "  4. é€šä¿¡ã¯ inbox_write.shï¼ˆYAML mailboxï¼‰"
            echo "  5. å›å¾©ã¯ inbox_watcher.shï¼ˆ3æ®µéšã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰"
            echo "  6. ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§è‡ªå‹•è¡¨ç¤ºï¼ˆiTerm2å„ªå…ˆã€Terminal.appãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰"
            echo ""
            echo "é™£å½¢:"
            echo "  å¹³æ™‚ã®é™£ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: è¶³è»½1-7=Sonnet, è»å¸«=Opus"
            echo "  æ±ºæˆ¦ã®é™£ï¼ˆ--kessenï¼‰:   å…¨è¶³è»½=Opus, è»å¸«=Opus"
            echo ""
            echo "ä¾‹:"
            echo "  ./shutsujin_teams.sh              # å‰å›ã®çŠ¶æ…‹ã‚’ç¶­æŒã—ã¦å‡ºé™£"
            echo "  ./shutsujin_teams.sh -c           # ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆã‚­ãƒ¥ãƒ¼ãƒªã‚»ãƒƒãƒˆï¼‰"
            echo "  ./shutsujin_teams.sh -s           # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã¿ï¼ˆæ‰‹å‹•ã§Claudeèµ·å‹•ï¼‰"
            echo "  ./shutsujin_teams.sh -k           # æ±ºæˆ¦ã®é™£ï¼ˆå…¨è¶³è»½Opusï¼‰"
            echo "  ./shutsujin_teams.sh -c -k        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆï¼‹æ±ºæˆ¦ã®é™£"
            echo "  ./shutsujin_teams.sh -shell bash  # bashç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§èµ·å‹•"
            echo "  ./shutsujin_teams.sh -S           # ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆechoè¡¨ç¤ºãªã—ï¼‰"
            echo "  ./shutsujin_teams.sh --model sonnet  # å°†è»ã‚’Sonnetã§èµ·å‹•"
            echo "  ./shutsujin_teams.sh --shogun-no-thinking  # å°†è»ã®thinkingã‚’ç„¡åŠ¹åŒ–ï¼ˆä¸­ç¶™ç‰¹åŒ–ï¼‰"
            echo ""
            echo "ãƒ¢ãƒ‡ãƒ«æ§‹æˆ:"
            echo "  å°†è»:      Opusï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‚--model ã§å¤‰æ›´å¯ï¼‰"
            echo "  å®¶è€:      Sonnetï¼ˆé«˜é€Ÿã‚¿ã‚¹ã‚¯ç®¡ç†ï¼‰"
            echo "  è»å¸«:      Opusï¼ˆæˆ¦ç•¥ç«‹æ¡ˆãƒ»è¨­è¨ˆåˆ¤æ–­ï¼‰"
            echo "  è¶³è»½1-7:   Sonnetï¼ˆå®Ÿåƒéƒ¨éšŠï¼‰"
            echo ""
            echo "è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:"
            echo "  shoutï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰:  ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ã«æˆ¦å›½é¢¨echoè¡¨ç¤º"
            echo "  silentï¼ˆ--silentï¼‰:   echoè¡¨ç¤ºãªã—ï¼ˆAPIç¯€ç´„ï¼‰"
            echo ""
            echo "ã‚¨ã‚¤ãƒªã‚¢ã‚¹:"
            echo "  csst â†’ cd ~/multi-agent-shogun && ./shutsujin_teams.sh"
            echo ""
            exit 0
            ;;
        *)
            echo "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            echo "./shutsujin_teams.sh -h ã§ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
            exit 1
            ;;
    esac
done

# ã‚·ã‚§ãƒ«è¨­å®šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
if [ -n "$SHELL_OVERRIDE" ]; then
    if [[ "$SHELL_OVERRIDE" == "bash" || "$SHELL_OVERRIDE" == "zsh" ]]; then
        SHELL_SETTING="$SHELL_OVERRIDE"
    else
        echo "ã‚¨ãƒ©ãƒ¼: -shell ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯ bash ã¾ãŸã¯ zsh ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆæŒ‡å®šå€¤: $SHELL_OVERRIDEï¼‰"
        exit 1
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å‡ºé™£ãƒãƒŠãƒ¼è¡¨ç¤º
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ã€è‘—ä½œæ¨©ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹è¡¨ç¤ºã€‘
# å¿è€…ASCIIã‚¢ãƒ¼ãƒˆ: syntax-samurai/ryu - CC0 1.0 Universal (Public Domain)
# å‡ºå…¸: https://github.com/syntax-samurai/ryu
show_battle_cry() {
    clear

    echo ""
    echo -e "\033[1;31mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m \033[1;33mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—\033[0m \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m \033[1;33mâ–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘\033[0m \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m \033[1;33mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘\033[0m \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m \033[1;33mâ•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆ   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘\033[0m \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m \033[1;33mâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘\033[0m \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m \033[1;33mâ•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•â•â•\033[0m \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\033[0m"
    echo -e "\033[1;31mâ•‘\033[0m    \033[1;37må‡ºé™£ã˜ã‚ƒãƒ¼ãƒ¼ãƒ¼ï¼ï¼ï¼\033[0m    \033[1;36mâš”\033[0m    \033[1;35må¤©ä¸‹å¸ƒæ­¦ï¼ â€” ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ\033[0m              \033[1;31mâ•‘\033[0m"
    echo -e "\033[1;31mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
    echo ""

    echo -e "\033[1;34m  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
    echo -e "\033[1;34m  â•‘\033[0m                \033[1;37mã€ è¶³ è»½ éšŠ åˆ— ãƒ» ä¸ƒ å + è» å¸« é… å‚™ ã€‘\033[0m                  \033[1;34mâ•‘\033[0m"
    echo -e "\033[1;34m  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"

    cat << 'ASHIGARU_EOF'

       /\      /\      /\      /\      /\      /\      /\      /\
      /||\    /||\    /||\    /||\    /||\    /||\    /||\    /||\
     /_||\   /_||\   /_||\   /_||\   /_||\   /_||\   /_||\   /_||\
       ||      ||      ||      ||      ||      ||      ||      ||
      /||\    /||\    /||\    /||\    /||\    /||\    /||\    /||\
      /  \    /  \    /  \    /  \    /  \    /  \    /  \    /  \
     [è¶³1]   [è¶³2]   [è¶³3]   [è¶³4]   [è¶³5]   [è¶³6]   [è¶³7]   [è»å¸«]

ASHIGARU_EOF

    echo -e "                    \033[1;36mã€Œã€Œã€Œ ã¯ã£ï¼ï¼ å‡ºé™£ã„ãŸã™ï¼ï¼ ã€ã€ã€\033[0m"
    echo ""

    echo -e "\033[1;33m  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“\033[0m"
    echo -e "\033[1;33m  â”ƒ\033[0m  \033[1;37mğŸ¯ multi-agent-shogun\033[0m  ã€œ \033[1;36mç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ\033[0m ã€œ                              \033[1;33mâ”ƒ\033[0m"
    echo -e "\033[1;33m  â”ƒ\033[0m                                                                           \033[1;33mâ”ƒ\033[0m"
    echo -e "\033[1;33m  â”ƒ\033[0m  \033[1;35må°†è»\033[0m: çµ±æ‹¬  \033[1;31må®¶è€\033[0m: ç®¡ç†  \033[1;33mè»å¸«\033[0m: æˆ¦ç•¥(Opus)  \033[1;34mè¶³è»½\033[0m: å®ŸåƒÃ—${_ASHIGARU_COUNT}                   \033[1;33mâ”ƒ\033[0m"
    echo -e "\033[1;33m  â”ƒ\033[0m  é€šä¿¡: inbox_write.sh (mailbox)  å›å¾©: inbox_watcher.sh                   \033[1;33mâ”ƒ\033[0m"
    echo -e "\033[1;33m  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›\033[0m"
    echo ""
}

# ãƒãƒŠãƒ¼è¡¨ç¤ºå®Ÿè¡Œ
show_battle_cry

echo -e "  \033[1;33må¤©ä¸‹å¸ƒæ­¦ï¼é™£ç«‹ã¦ã‚’é–‹å§‹ã„ãŸã™\033[0m (Setting up the battlefield â€” Independent Processes)"
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 0: CRLFæ”¹è¡Œä¿®æ­£ï¼ˆDropbox syncå¯¾ç­–ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DropboxãŒãƒ•ã‚¡ã‚¤ãƒ«syncæ™‚ã«CRLFã‚’æ··å…¥ã•ã›ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
# bashã‚¹ã‚¯ãƒªãƒ—ãƒˆã«CRLFãŒæ··ã–ã‚‹ã¨å³æ­»ã™ã‚‹ãŸã‚ã€èµ·å‹•å‰ã«å…¨.shã‚’LFã«çµ±ä¸€ã€‚
_crlf_fixed=0
for _f in "$SCRIPT_DIR"/scripts/*.sh "$SCRIPT_DIR"/lib/*.sh; do
    [ -f "$_f" ] || continue
    if file "$_f" | grep -q CRLF; then
        sed -i '' $'s/\r$//' "$_f"
        _crlf_fixed=$((_crlf_fixed + 1))
    fi
done
[ "$_crlf_fixed" -gt 0 ] && log_info "ğŸ”§ CRLFä¿®æ­£: ${_crlf_fixed}ãƒ•ã‚¡ã‚¤ãƒ«" || true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1: æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
log_info "ğŸ§¹ æ—¢å­˜ã®é™£ã‚’æ’¤åä¸­..."
# ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ: shogun-teams + multiagent-teams ã‚»ãƒƒã‚·ãƒ§ãƒ³ + inbox_watcher ã‚’æ’¤å
tmux kill-session -t shogun-teams 2>/dev/null && log_info "  â””â”€ shogun-teamsé™£ã€æ’¤åå®Œäº†" || log_info "  â””â”€ shogun-teamsé™£ã¯å­˜åœ¨ã›ãš"
tmux kill-session -t multiagent-teams 2>/dev/null && log_info "  â””â”€ multiagent-teamsé™£ã€æ’¤åå®Œäº†" || log_info "  â””â”€ multiagent-teamsé™£ã¯å­˜åœ¨ã›ãš"
pkill -f "inbox_watcher.sh" 2>/dev/null && log_info "  â””â”€ inbox_watcheræ’¤åå®Œäº†" || true
pkill -f "teams_visual_monitor.sh" 2>/dev/null && log_info "  â””â”€ visual_monitoræ’¤åå®Œäº†" || true
pkill -f "inotifywait.*queue/inbox" 2>/dev/null || true
pkill -f "fswatch.*queue/inbox" 2>/dev/null || true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 1.5: å‰å›è¨˜éŒ²ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ--cleanæ™‚ã®ã¿ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$CLEAN_MODE" = true ]; then
    BACKUP_DIR="./logs/backup_$(date '+%Y%m%d_%H%M%S')"
    NEED_BACKUP=false

    if [ -f "./dashboard.md" ]; then
        if grep -q "cmd_" "./dashboard.md" 2>/dev/null; then
            NEED_BACKUP=true
        fi
    fi

    if [ -f "./queue/shogun_to_karo.yaml" ]; then
        if grep -q "id: cmd_" "./queue/shogun_to_karo.yaml" 2>/dev/null; then
            NEED_BACKUP=true
        fi
    fi

    if [ "$NEED_BACKUP" = true ]; then
        mkdir -p "$BACKUP_DIR" || true
        cp "./dashboard.md" "$BACKUP_DIR/" 2>/dev/null || true
        cp -r "./queue/reports" "$BACKUP_DIR/" 2>/dev/null || true
        cp -r "./queue/tasks" "$BACKUP_DIR/" 2>/dev/null || true
        cp "./queue/shogun_to_karo.yaml" "$BACKUP_DIR/" 2>/dev/null || true
        log_info "ğŸ“¦ å‰å›ã®è¨˜éŒ²ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: $BACKUP_DIR"
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 2: ã‚­ãƒ¥ãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºä¿ + ãƒªã‚»ãƒƒãƒˆï¼ˆ--cleanæ™‚ã®ã¿ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[ -d ./queue/reports ] || mkdir -p ./queue/reports
[ -d ./queue/tasks ] || mkdir -p ./queue/tasks
# ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ: inboxãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯mailboxé€šä¿¡ã«å¿…é ˆ
[ -d ./queue/inbox ] || mkdir -p ./queue/inbox

if [ "$CLEAN_MODE" = true ]; then
    log_info "ğŸ“œ å‰å›ã®è»è­°è¨˜éŒ²ã‚’ç ´æ£„ä¸­..."

    # è¶³è»½ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
    for i in $(seq 1 "$_ASHIGARU_COUNT"); do
        cat > ./queue/tasks/ashigaru${i}.yaml << EOF
# è¶³è»½${i}å°‚ç”¨ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«
task:
  task_id: null
  parent_cmd: null
  description: null
  target_path: null
  status: idle
  timestamp: ""
EOF
    done

    # è»å¸«ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
    cat > ./queue/tasks/gunshi.yaml << EOF
# è»å¸«å°‚ç”¨ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«
task:
  task_id: null
  parent_cmd: null
  description: null
  target_path: null
  status: idle
  timestamp: ""
EOF

    # è¶³è»½ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
    for i in $(seq 1 "$_ASHIGARU_COUNT"); do
        cat > ./queue/reports/ashigaru${i}_report.yaml << EOF
worker_id: ashigaru${i}
task_id: null
timestamp: ""
status: idle
result: null
EOF
    done

    # è»å¸«ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
    cat > ./queue/reports/gunshi_report.yaml << EOF
worker_id: gunshi
task_id: null
timestamp: ""
status: idle
result: null
EOF

    # ntfy inbox ãƒªã‚»ãƒƒãƒˆ
    echo "inbox:" > ./queue/ntfy_inbox.yaml

    # agent inbox ãƒªã‚»ãƒƒãƒˆï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
    for agent in shogun karo $_ASHIGARU_IDS_STR gunshi; do
        echo "messages:" > "./queue/inbox/${agent}.yaml"
    done

    log_success "âœ… é™£æ‰•ã„å®Œäº†"
else
    log_info "ğŸ“œ å‰å›ã®é™£å®¹ã‚’ç¶­æŒã—ã¦å‡ºé™£..."
    log_success "âœ… ã‚­ãƒ¥ãƒ¼ãƒ»å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«ã¯ãã®ã¾ã¾ç¶™ç¶š"
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 3: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–ï¼ˆ--cleanæ™‚ã®ã¿ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$CLEAN_MODE" = true ]; then
    log_info "ğŸ“Š æˆ¦æ³å ±å‘Šæ¿ã‚’åˆæœŸåŒ–ä¸­..."

    # update_dashboard.sh ãŒã‚ã‚Œã°ä½¿ã†ã€ãªã‘ã‚Œã°ç›´æ¥ç”Ÿæˆ
    if [ -f "$SCRIPT_DIR/scripts/update_dashboard.sh" ]; then
        bash "$SCRIPT_DIR/scripts/update_dashboard.sh" --init
    else
        TIMESTAMP=$(date "+%Y-%m-%d %H:%M")

        if [ "$LANG_SETTING" = "ja" ]; then
            # æ—¥æœ¬èªã®ã¿
            cat > ./dashboard.md << EOF
# ğŸ“Š æˆ¦æ³å ±å‘Š
æœ€çµ‚æ›´æ–°: ${TIMESTAMP}

## ğŸš¨ è¦å¯¾å¿œ - æ®¿ã®ã”åˆ¤æ–­ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™
ãªã—

## ğŸ”„ é€²è¡Œä¸­ - åªä»Šã€æˆ¦é—˜ä¸­ã§ã”ã–ã‚‹
ãªã—

## âœ… æœ¬æ—¥ã®æˆ¦æœ
| æ™‚åˆ» | æˆ¦å ´ | ä»»å‹™ | çµæœ |
|------|------|------|------|

## ğŸ¯ ã‚¹ã‚­ãƒ«åŒ–å€™è£œ - æ‰¿èªå¾…ã¡
ãªã—

## ğŸ› ï¸ ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚­ãƒ«
ãªã—

## â¸ï¸ å¾…æ©Ÿä¸­
ãªã—

## â“ ä¼ºã„äº‹é …
ãªã—
EOF
        else
            # æ—¥æœ¬èª + ç¿»è¨³ä½µè¨˜
            cat > ./dashboard.md << EOF
# ğŸ“Š æˆ¦æ³å ±å‘Š (Battle Status Report)
æœ€çµ‚æ›´æ–° (Last Updated): ${TIMESTAMP}

## ğŸš¨ è¦å¯¾å¿œ - æ®¿ã®ã”åˆ¤æ–­ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ (Action Required - Awaiting Lord's Decision)
ãªã— (None)

## ğŸ”„ é€²è¡Œä¸­ - åªä»Šã€æˆ¦é—˜ä¸­ã§ã”ã–ã‚‹ (In Progress - Currently in Battle)
ãªã— (None)

## âœ… æœ¬æ—¥ã®æˆ¦æœ (Today's Achievements)
| æ™‚åˆ» (Time) | æˆ¦å ´ (Battlefield) | ä»»å‹™ (Mission) | çµæœ (Result) |
|------|------|------|------|

## ğŸ¯ ã‚¹ã‚­ãƒ«åŒ–å€™è£œ - æ‰¿èªå¾…ã¡ (Skill Candidates - Pending Approval)
ãªã— (None)

## ğŸ› ï¸ ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚­ãƒ« (Generated Skills)
ãªã— (None)

## â¸ï¸ å¾…æ©Ÿä¸­ (On Standby)
ãªã— (None)

## â“ ä¼ºã„äº‹é … (Questions for Lord)
ãªã— (None)
EOF
        fi
    fi

    log_success "  â””â”€ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº† (è¨€èª: $LANG_SETTING, ã‚·ã‚§ãƒ«: $SHELL_SETTING)"
else
    log_info "ğŸ“Š å‰å›ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¶­æŒ"
fi
echo ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 4: tmux ã®å­˜åœ¨ç¢ºèª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if ! command -v tmux &> /dev/null; then
    echo ""
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘  [ERROR] tmux not found!                               â•‘"
    echo "  â•‘  tmux ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“                                 â•‘"
    echo "  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "  â•‘  Run first_setup.sh first:                             â•‘"
    echo "  â•‘     ./first_setup.sh                                   â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 5: ç’°å¢ƒå¤‰æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ç‰ˆ: Agent Teams ã¯ä½¿ç”¨ã—ãªã„ï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯å›é¿ï¼‰
# export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1  â† å»ƒæ­¢
export SHOGUN_ROOT="$SCRIPT_DIR"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 5.5: ntfy_inbox å¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€€é¿ï¼ˆ7æ—¥ã‚ˆã‚Šå‰ã®processedåˆ†ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ -f ./queue/ntfy_inbox.yaml ]; then
    _archive_result=$("$VENV_DIR/bin/python3" -c "
import yaml, sys
from datetime import datetime, timedelta, timezone

INBOX = './queue/ntfy_inbox.yaml'
ARCHIVE = './queue/ntfy_inbox_archive.yaml'
DAYS = 7

with open(INBOX) as f:
    data = yaml.safe_load(f) or {}

entries = data.get('inbox', []) or []
if not entries:
    sys.exit(0)

cutoff = datetime.now(timezone(timedelta(hours=9))) - timedelta(days=DAYS)
recent, old = [], []

for e in entries:
    ts = e.get('timestamp', '')
    try:
        dt = datetime.fromisoformat(str(ts))
        if dt < cutoff and e.get('status') == 'processed':
            old.append(e)
        else:
            recent.append(e)
    except Exception:
        recent.append(e)

if not old:
    sys.exit(0)

try:
    with open(ARCHIVE) as f:
        archive = yaml.safe_load(f) or {}
except FileNotFoundError:
    archive = {}
archive_entries = archive.get('inbox', []) or []
archive_entries.extend(old)
with open(ARCHIVE, 'w') as f:
    yaml.dump({'inbox': archive_entries}, f, allow_unicode=True, default_flow_style=False)

with open(INBOX, 'w') as f:
    yaml.dump({'inbox': recent}, f, allow_unicode=True, default_flow_style=False)

print(f'{len(old)}ä»¶é€€é¿ {len(recent)}ä»¶ä¿æŒ')
" 2>/dev/null) || true
    if [ -n "$_archive_result" ]; then
        log_info "ğŸ“± ntfy_inboxæ•´ç†: $_archive_result â†’ ntfy_inbox_archive.yaml"
    fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# STEP 6: tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³æ§‹ç¯‰ + Claude Code èµ·å‹•ï¼ˆç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if [ "$SETUP_ONLY" = false ]; then
    # CLI ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    if [ "$CLI_ADAPTER_LOADED" = true ]; then
        _default_cli=$(get_cli_type "")
        if ! validate_cli_availability "$_default_cli"; then
            exit 1
        fi
    else
        if ! command -v npx &> /dev/null && ! command -v claude &> /dev/null; then
            log_info "âš ï¸  claude / npx ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "  first_setup.sh ã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
            exit 1
        fi
    fi

    # --shogun-no-thinking å‡¦ç†
    if [ "$SHOGUN_NO_THINKING" = true ] && [ "$CLI_ADAPTER_LOADED" = true ]; then
        "$CLI_ADAPTER_PROJECT_ROOT/.venv/bin/python3" -c "
import yaml
f = '${CLI_ADAPTER_SETTINGS}'
with open(f) as fh: d = yaml.safe_load(fh) or {}
d.setdefault('cli',{}).setdefault('agents',{}).setdefault('shogun',{})['thinking'] = False
with open(f,'w') as fh: yaml.safe_dump(d, fh, default_flow_style=False, allow_unicode=True, sort_keys=False)
" 2>/dev/null
        log_info "  â””â”€ å°†è» settings.yaml thinking=false ã«è¨­å®š"
    fi

    # DISPLAY_MODE ç’°å¢ƒå¤‰æ•°
    if [ "$SILENT_MODE" = true ]; then
        export DISPLAY_MODE="silent"
        log_info "ğŸ“¢ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: ã‚µã‚¤ãƒ¬ãƒ³ãƒˆï¼ˆechoè¡¨ç¤ºãªã—ï¼‰"
    else
        export DISPLAY_MODE="shout"
    fi

    # KESSEN_MODE ç’°å¢ƒå¤‰æ•°ï¼ˆæ±ºæˆ¦ã®é™£ï¼‰
    if [ "$KESSEN_MODE" = true ]; then
        export KESSEN_MODE=true
    fi

    # å¿è€…ã‚¢ã‚¹ã‚­ãƒ¼ã‚¢ãƒ¼ãƒˆï¼ˆCC0 Public Domainï¼‰
    echo -e "\033[1;35m  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\033[0m"
    echo -e "\033[1;35m  â”‚\033[0m                              \033[1;37mã€ å¿ è€… æˆ¦ å£« ã€‘\033[0m  Ryu Hayabusa (CC0 Public Domain)                        \033[1;35mâ”‚\033[0m"
    echo -e "\033[1;35m  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\033[0m"

    cat << 'NINJA_EOF'
...................................â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’                        ...................................
..................................â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’                        ...................................
..................................â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’                        ...................................
..................................â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’                        ...................................
..................................â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’                        ...................................
..................................â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–’â–’â–’â–’â–’â–’                         ...................................
NINJA_EOF

    echo ""
    echo -e "                                    \033[1;35mã€Œ å¤©ä¸‹å¸ƒæ­¦ï¼å‹åˆ©ã‚’æ´ã‚ï¼ ã€\033[0m"
    echo ""
    echo -e "                               \033[0;36m[ASCII Art: syntax-samurai/ryu - CC0 1.0 Public Domain]\033[0m"
    echo ""

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 6.1: shogun-teams ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆå°†è»ã®æœ¬é™£ï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    log_war "ğŸ‘‘ å°†è»ã®æœ¬é™£ã‚’æ§‹ç¯‰ä¸­..."

    # pane-base-index ã‚’å–å¾—ï¼ˆ1 ã®ç’°å¢ƒã§ã¯ãƒšã‚¤ãƒ³ã¯ 1,2,... ã«ãªã‚‹ï¼‰
    PANE_BASE=$(tmux show-options -gv pane-base-index 2>/dev/null || echo 0)

    if ! tmux has-session -t shogun-teams 2>/dev/null; then
        tmux new-session -d -s shogun-teams -n main
    fi

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® .tmux.conf ã‚’åæ˜ ï¼ˆbg=#ffffff ç­‰ï¼‰
    tmux source-file ~/.tmux.conf 2>/dev/null || true

    # ã‚¹ãƒãƒ›ç­‰ã®å°ç”»é¢ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå¯¾ç­–
    tmux set-option -g window-size latest
    tmux set-option -g aggressive-resize on

    SHOGUN_PROMPT=$(generate_prompt "å°†è»" "magenta" "$SHELL_SETTING")
    tmux send-keys -t "shogun-teams:main" "cd \"$(pwd)\" && export PS1='${SHOGUN_PROMPT}' && clear" Enter
    tmux set-option -p -t "shogun-teams:main" @agent_id "shogun"

    log_success "  â””â”€ å°†è»ã®æœ¬é™£ã€æ§‹ç¯‰å®Œäº†"
    echo ""

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 6.2: multiagent-teams ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆå®¶è€å¤§ + 2Ã—4 = 9ãƒšã‚¤ãƒ³ï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    log_war "âš”ï¸ å®¶è€ãƒ»è¶³è»½ãƒ»è»å¸«ã®é™£ã‚’æ§‹ç¯‰ä¸­ï¼ˆ$((${_ASHIGARU_COUNT} + 2))åé…å‚™ï¼‰..."

    if ! tmux new-session -d -s multiagent-teams -n "agents" -x 200 -y 60 2>/dev/null; then
        echo ""
        echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "  â•‘  [ERROR] Failed to create tmux session 'multiagent-teams'  â•‘"
        echo "  â•‘  tmux ã‚»ãƒƒã‚·ãƒ§ãƒ³ 'multiagent-teams' ã®ä½œæˆã«å¤±æ•—           â•‘"
        echo "  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "  â•‘  æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™                â•‘"
        echo "  â•‘  Check: tmux ls                                            â•‘"
        echo "  â•‘  Kill:  tmux kill-session -t multiagent-teams              â•‘"
        echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        exit 1
    fi

    # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ: ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼(attach)ã®ã‚µã‚¤ã‚ºã«è‡ªå‹•è¿½å¾“
    tmux set-option -t multiagent-teams -w aggressive-resize on

    # DISPLAY_MODE ã‚’ tmux ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
    if [ "$SILENT_MODE" = true ]; then
        tmux set-environment -t multiagent-teams DISPLAY_MODE "silent"
        log_info "ğŸ“¢ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: ã‚µã‚¤ãƒ¬ãƒ³ãƒˆï¼ˆechoè¡¨ç¤ºãªã—ï¼‰"
    else
        tmux set-environment -t multiagent-teams DISPLAY_MODE "shout"
    fi

    # KESSEN_MODE ã‚‚ tmux ç’°å¢ƒå¤‰æ•°ã«ã‚»ãƒƒãƒˆ
    if [ "$KESSEN_MODE" = true ]; then
        tmux set-environment -t multiagent-teams KESSEN_MODE "true"
    fi

    # å®¶è€å¤§ãƒšã‚¤ãƒ³ + 2Ã—4ã‚°ãƒªãƒƒãƒ‰ï¼ˆåˆè¨ˆ9ãƒšã‚¤ãƒ³ï¼‰
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
    # â”‚          â”‚  A1  â”‚  A2  â”‚
    # â”‚          â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
    # â”‚   å®¶è€   â”‚  A3  â”‚  A6  â”‚
    # â”‚  (1/3å¹…  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
    # â”‚  å…¨é«˜)   â”‚  A4  â”‚  A7  â”‚
    # â”‚          â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
    # â”‚          â”‚  A5  â”‚ è»å¸« â”‚
    # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

    # Step 1: å®¶è€(å·¦33%) ã¨ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé ˜åŸŸ(å³67%) ã«åˆ†å‰²
    tmux split-window -h -p 67 -t "multiagent-teams:agents"

    # Step 2: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé ˜åŸŸã‚’2åˆ—ã«åˆ†å‰²
    tmux split-window -h -t "multiagent-teams:agents.$((PANE_BASE+1))"

    # Step 3: ä¸­å¤®åˆ—ã‚’4ç­‰åˆ†ï¼ˆè¶³è»½1,3,4,5ï¼‰
    tmux select-pane -t "multiagent-teams:agents.$((PANE_BASE+1))"
    tmux split-window -v -p 75
    tmux split-window -v -p 67
    tmux split-window -v

    # Step 4: å³åˆ—ã‚’4ç­‰åˆ†ï¼ˆè¶³è»½2,6,7,è»å¸«ï¼‰
    tmux select-pane -t "multiagent-teams:agents.$((PANE_BASE+2))"
    tmux split-window -v -p 75
    tmux split-window -v -p 67
    tmux split-window -v

    # ãƒšã‚¤ãƒ³ãƒ©ãƒ™ãƒ«ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆIDè¨­å®š â€” settings.yaml ã‹ã‚‰å‹•çš„ã«æ§‹ç¯‰
    PANE_LABELS=("karo")
    AGENT_IDS=("karo")
    PANE_COLORS=("red")
    for _ai in $_ASHIGARU_IDS_STR; do
        PANE_LABELS+=("$_ai")
        AGENT_IDS+=("$_ai")
        PANE_COLORS+=("blue")
    done
    PANE_LABELS+=("gunshi")
    AGENT_IDS+=("gunshi")
    PANE_COLORS+=("yellow")

    # ãƒ¢ãƒ‡ãƒ«åè¨­å®šï¼ˆpane-border-format ã§å¸¸æ™‚è¡¨ç¤ºï¼‰
    MODEL_NAMES=()
    for _ai in "${AGENT_IDS[@]}"; do
        if [[ "$_ai" == "gunshi" ]]; then
            MODEL_NAMES+=("Opus")
        elif [ "$KESSEN_MODE" = true ]; then
            MODEL_NAMES+=("Opus")
        else
            MODEL_NAMES+=("Sonnet")
        fi
    done

    # CLI Adapter çµŒç”±ã§ãƒ¢ãƒ‡ãƒ«è¡¨ç¤ºåã‚’çµ±ä¸€å½¢å¼ã§è¨­å®š
    if [ "$CLI_ADAPTER_LOADED" = true ]; then
        for i in "${!AGENT_IDS[@]}"; do
            _agent="${AGENT_IDS[$i]}"
            MODEL_NAMES[$i]=$(get_model_display_name "$_agent")
        done
    fi

    for i in "${!AGENT_IDS[@]}"; do
        p=$((PANE_BASE + i))
        tmux select-pane -t "multiagent-teams:agents.${p}" -T "${MODEL_NAMES[$i]}"
        tmux set-option -p -t "multiagent-teams:agents.${p}" @agent_id "${AGENT_IDS[$i]}"
        tmux set-option -p -t "multiagent-teams:agents.${p}" @model_name "${MODEL_NAMES[$i]}"
        tmux set-option -p -t "multiagent-teams:agents.${p}" @current_task ""
        PROMPT_STR=$(generate_prompt "${PANE_LABELS[$i]}" "${PANE_COLORS[$i]}" "$SHELL_SETTING")
        tmux send-keys -t "multiagent-teams:agents.${p}" "cd \"$(pwd)\" && export PS1='${PROMPT_STR}' && clear" Enter
    done

    # pane-border-format ã§ãƒ¢ãƒ‡ãƒ«åã‚’å¸¸æ™‚è¡¨ç¤º
    tmux set-option -t multiagent-teams -w pane-border-status top
    tmux set-option -t multiagent-teams -w pane-border-format \
      '#{?pane_active,#[reverse],}#[bold]#{@agent_id}#[default] (#{@model_name}) #{@current_task}'

    # å®¶è€ãƒšã‚¤ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¦ãŠãï¼ˆãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«ï¼‰
    tmux select-pane -t "multiagent-teams:agents.${PANE_BASE}"

    log_success "  â””â”€ å®¶è€ãƒ»è¶³è»½ãƒ»è»å¸«ã®é™£ã€æ§‹ç¯‰å®Œäº†"
    echo ""

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 6.3: å…¨è»ã« Claude Code ã‚’å¬å–šï¼ˆç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    log_war "ğŸ‘‘ å…¨è»ã« Claude Code ã‚’å¬å–šä¸­..."

    # Agent Teams ç’°å¢ƒå¤‰æ•°ã‚’ç„¡åŠ¹åŒ–ï¼ˆ.zshrc / launchctl ç”±æ¥ã®æ®‹ç•™ã‚’é™¤å»ï¼‰
    # ã“ã‚ŒãŒãªã„ã¨ Claude Code ãŒ Agent Teams ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã€mailbox ã§ã¯ãªã
    # å†…è”µ teammate ã‚’ spawn ã—ã¦ã—ã¾ã„ã€ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ãŒä½¿ã‚ã‚Œãªã„
    tmux send-keys -t "shogun-teams:main" "unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS" Enter
    for _p in $(seq "$PANE_BASE" "$((PANE_BASE + _ASHIGARU_COUNT + 1))"); do
        tmux send-keys -t "multiagent-teams:agents.${_p}" "unset CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS" Enter
    done
    sleep 0.5

    # å°†è»: CLI Adapter çµŒç”±ã§ã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰
    _shogun_cli_type="claude"
    _shogun_cmd="claude --model ${MODEL} --dangerously-skip-permissions"
    if [ "$CLI_ADAPTER_LOADED" = true ]; then
        _shogun_cli_type=$(get_cli_type "shogun")
        _shogun_cmd=$(build_cli_command "shogun")
    fi
    if [ "$SHOGUN_NO_THINKING" = true ] && [ "$CLI_ADAPTER_LOADED" = true ]; then
        _shogun_cmd=$(build_cli_command "shogun")
    fi
    tmux set-option -p -t "shogun-teams:main" @agent_cli "$_shogun_cli_type"
    tmux send-keys -t "shogun-teams:main" "$_shogun_cmd"
    tmux send-keys -t "shogun-teams:main" Enter
    _shogun_display=$(get_model_display_name "shogun" 2>/dev/null || echo "Opus")
    tmux set-option -p -t "shogun-teams:main" @model_name "$_shogun_display" 2>/dev/null || true
    log_info "  â””â”€ å°†è»ï¼ˆ${_shogun_cli_type} / ${_shogun_display}ï¼‰ã€å¬å–šå®Œäº†"

    sleep 1

    # å®¶è€ï¼ˆpane 0ï¼‰
    p=$((PANE_BASE + 0))
    _karo_cli_type="claude"
    _karo_cmd="claude --model sonnet --dangerously-skip-permissions"
    if [ "$CLI_ADAPTER_LOADED" = true ]; then
        _karo_cli_type=$(get_cli_type "karo")
        _karo_cmd=$(build_cli_command "karo")
    fi
    _startup_prompt=$(get_startup_prompt "karo" 2>/dev/null)
    if [[ -n "$_startup_prompt" ]]; then
        _karo_cmd="$_karo_cmd \"$_startup_prompt\""
    fi
    tmux set-option -p -t "multiagent-teams:agents.${p}" @agent_cli "$_karo_cli_type"
    tmux send-keys -t "multiagent-teams:agents.${p}" "$_karo_cmd"
    tmux send-keys -t "multiagent-teams:agents.${p}" Enter
    _karo_display=$(get_model_display_name "karo" 2>/dev/null || echo "Sonnet")
    tmux set-option -p -t "multiagent-teams:agents.${p}" @model_name "$_karo_display" 2>/dev/null || true
    log_info "  â””â”€ å®¶è€ï¼ˆ${_karo_display}ï¼‰ã€å¬å–šå®Œäº†"

    # è¶³è»½
    if [ "$KESSEN_MODE" = true ]; then
        for i in $(seq 1 "$_ASHIGARU_COUNT"); do
            p=$((PANE_BASE + i))
            _ashi_cli_type="claude"
            _ashi_cmd="claude --model opus --dangerously-skip-permissions"
            if [ "$CLI_ADAPTER_LOADED" = true ]; then
                _ashi_cli_type=$(get_cli_type "ashigaru${i}")
                if [ "$_ashi_cli_type" = "claude" ]; then
                    _ashi_cmd="claude --model opus --dangerously-skip-permissions"
                else
                    _ashi_cmd=$(build_cli_command "ashigaru${i}")
                fi
            fi
            _startup_prompt=$(get_startup_prompt "ashigaru${i}" 2>/dev/null)
            if [[ -n "$_startup_prompt" ]]; then
                _ashi_cmd="$_ashi_cmd \"$_startup_prompt\""
            fi
            tmux set-option -p -t "multiagent-teams:agents.${p}" @agent_cli "$_ashi_cli_type"
            tmux send-keys -t "multiagent-teams:agents.${p}" "$_ashi_cmd"
            tmux send-keys -t "multiagent-teams:agents.${p}" Enter
        done
        log_info "  â””â”€ è¶³è»½1-${_ASHIGARU_COUNT}ï¼ˆæ±ºæˆ¦ã®é™£ï¼‰ã€å¬å–šå®Œäº†"
    else
        for i in $(seq 1 "$_ASHIGARU_COUNT"); do
            p=$((PANE_BASE + i))
            _ashi_cli_type="claude"
            _ashi_cmd="claude --model sonnet --dangerously-skip-permissions"
            if [ "$CLI_ADAPTER_LOADED" = true ]; then
                _ashi_cli_type=$(get_cli_type "ashigaru${i}")
                _ashi_cmd=$(build_cli_command "ashigaru${i}")
            fi
            _startup_prompt=$(get_startup_prompt "ashigaru${i}" 2>/dev/null)
            if [[ -n "$_startup_prompt" ]]; then
                _ashi_cmd="$_ashi_cmd \"$_startup_prompt\""
            fi
            tmux set-option -p -t "multiagent-teams:agents.${p}" @agent_cli "$_ashi_cli_type"
            tmux send-keys -t "multiagent-teams:agents.${p}" "$_ashi_cmd"
            tmux send-keys -t "multiagent-teams:agents.${p}" Enter
        done
        log_info "  â””â”€ è¶³è»½1-${_ASHIGARU_COUNT}ï¼ˆå¹³æ™‚ã®é™£ï¼‰ã€å¬å–šå®Œäº†"
    fi

    # è»å¸«ï¼ˆæœ€çµ‚ãƒšã‚¤ãƒ³ï¼‰
    p=$((PANE_BASE + _ASHIGARU_COUNT + 1))
    _gunshi_cli_type="claude"
    _gunshi_cmd="claude --model opus --dangerously-skip-permissions"
    if [ "$CLI_ADAPTER_LOADED" = true ]; then
        _gunshi_cli_type=$(get_cli_type "gunshi")
        _gunshi_cmd=$(build_cli_command "gunshi")
    fi
    _startup_prompt=$(get_startup_prompt "gunshi" 2>/dev/null)
    if [[ -n "$_startup_prompt" ]]; then
        _gunshi_cmd="$_gunshi_cmd \"$_startup_prompt\""
    fi
    tmux set-option -p -t "multiagent-teams:agents.${p}" @agent_cli "$_gunshi_cli_type"
    tmux send-keys -t "multiagent-teams:agents.${p}" "$_gunshi_cmd"
    tmux send-keys -t "multiagent-teams:agents.${p}" Enter
    _gunshi_display=$(get_model_display_name "gunshi" 2>/dev/null || echo "Opus+T")
    tmux set-option -p -t "multiagent-teams:agents.${p}" @model_name "$_gunshi_display" 2>/dev/null || true
    log_info "  â””â”€ è»å¸«ï¼ˆ${_gunshi_display}ï¼‰ã€å¬å–šå®Œäº†"

    if [ "$KESSEN_MODE" = true ]; then
        log_success "âœ… æ±ºæˆ¦ã®é™£ã§å‡ºé™£ï¼å…¨è»Opusï¼"
    else
        log_success "âœ… å¹³æ™‚ã®é™£ã§å‡ºé™£ï¼ˆå°†è»=Opus, å®¶è€=Sonnet, è¶³è»½=Sonnet, è»å¸«=Opusï¼‰"
    fi
    echo ""

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 6.4: æŒ‡ç¤ºæ›¸èª­ã¿è¾¼ã¿ï¼ˆå„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè‡ªå¾‹å®Ÿè¡Œï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    log_info "ğŸ“œ æŒ‡ç¤ºæ›¸èª­ã¿è¾¼ã¿ã¯å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè‡ªå¾‹å®Ÿè¡Œï¼ˆCLAUDE.md Session Startï¼‰"
    echo ""

    # å°†è»ã®èµ·å‹•ã‚’ç¢ºèªï¼ˆæœ€å¤§30ç§’å¾…æ©Ÿï¼‰
    echo "  Claude Code ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­ï¼ˆæœ€å¤§30ç§’ï¼‰..."
    for _wait_i in {1..30}; do
        if tmux capture-pane -t "shogun-teams:main" -p | grep -q "bypass permissions"; then
            echo "  â””â”€ å°†è»ã® Claude Code èµ·å‹•ç¢ºèªå®Œäº†ï¼ˆ${_wait_i}ç§’ï¼‰"
            break
        fi
        sleep 1
    done

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 6.5: inbox_watcher èµ·å‹•ï¼ˆå…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    log_info "ğŸ“¬ ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ç›£è¦–ã‚’èµ·å‹•ä¸­..."
    mkdir -p "$SCRIPT_DIR/logs"

    # inbox ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆæœŸåŒ–
    for agent in shogun karo $_ASHIGARU_IDS_STR gunshi; do
        [ -f "$SCRIPT_DIR/queue/inbox/${agent}.yaml" ] || echo "messages:" > "$SCRIPT_DIR/queue/inbox/${agent}.yaml"
    done

    # å°†è»ã®watcherï¼ˆntfyå—ä¿¡ã®è‡ªå‹•èµ·åºŠã«å¿…è¦ï¼‰
    _shogun_watcher_cli=$(tmux show-options -p -t "shogun-teams:main" -v @agent_cli 2>/dev/null || echo "claude")
    nohup env ASW_DISABLE_ESCALATION=1 ASW_PROCESS_TIMEOUT=0 ASW_DISABLE_NORMAL_NUDGE=0 \
        bash "$SCRIPT_DIR/scripts/inbox_watcher.sh" shogun "shogun-teams:main" "$_shogun_watcher_cli" \
        >> "$SCRIPT_DIR/logs/inbox_watcher_shogun.log" 2>&1 &
    disown

    # å®¶è€ã®watcher
    _karo_watcher_cli=$(tmux show-options -p -t "multiagent-teams:agents.${PANE_BASE}" -v @agent_cli 2>/dev/null || echo "claude")
    nohup bash "$SCRIPT_DIR/scripts/inbox_watcher.sh" karo "multiagent-teams:agents.${PANE_BASE}" "$_karo_watcher_cli" \
        >> "$SCRIPT_DIR/logs/inbox_watcher_karo.log" 2>&1 &
    disown

    # è¶³è»½ã®watcher
    for i in $(seq 1 "$_ASHIGARU_COUNT"); do
        p=$((PANE_BASE + i))
        _ashi_watcher_cli=$(tmux show-options -p -t "multiagent-teams:agents.${p}" -v @agent_cli 2>/dev/null || echo "claude")
        nohup bash "$SCRIPT_DIR/scripts/inbox_watcher.sh" "ashigaru${i}" "multiagent-teams:agents.${p}" "$_ashi_watcher_cli" \
            >> "$SCRIPT_DIR/logs/inbox_watcher_ashigaru${i}.log" 2>&1 &
        disown
    done

    # è»å¸«ã®watcher
    p=$((PANE_BASE + _ASHIGARU_COUNT + 1))
    _gunshi_watcher_cli=$(tmux show-options -p -t "multiagent-teams:agents.${p}" -v @agent_cli 2>/dev/null || echo "claude")
    nohup bash "$SCRIPT_DIR/scripts/inbox_watcher.sh" "gunshi" "multiagent-teams:agents.${p}" "$_gunshi_watcher_cli" \
        >> "$SCRIPT_DIR/logs/inbox_watcher_gunshi.log" 2>&1 &
    disown

    log_success "  â””â”€ $((_ASHIGARU_COUNT + 3))ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ†ã®inbox_watcherèµ·å‹•å®Œäº†ï¼ˆå°†è»+å®¶è€+è¶³è»½${_ASHIGARU_COUNT}+è»å¸«ï¼‰"

    # health_checker: å…¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå·¡å›ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆstuckæ¤œå‡º + æœªèª­ãƒªãƒˆãƒ©ã‚¤ + compactå¾©æ—§ï¼‰
    pkill -f "health_checker.sh" 2>/dev/null || true
    sleep 0.5
    nohup bash "$SCRIPT_DIR/scripts/health_checker.sh" 30 \
        >> "$SCRIPT_DIR/logs/health_checker.log" 2>&1 &
    disown
    log_success "  â””â”€ health_checker èµ·å‹•ï¼ˆ30ç§’å·¡å›ï¼‰"
    echo ""

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 6.6: ntfy å…¥åŠ›ãƒªã‚¹ãƒŠãƒ¼èµ·å‹•
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    NTFY_TOPIC=$(grep 'ntfy_topic:' ./config/settings.yaml 2>/dev/null | awk '{print $2}' | tr -d '"')
    if [ -n "$NTFY_TOPIC" ]; then
        pkill -f "ntfy_listener.sh" 2>/dev/null || true
        [ ! -f ./queue/ntfy_inbox.yaml ] && echo "inbox:" > ./queue/ntfy_inbox.yaml
        nohup bash "$SCRIPT_DIR/scripts/ntfy_listener.sh" &>/dev/null &
        disown
        log_info "ğŸ“± ntfyå…¥åŠ›ãƒªã‚¹ãƒŠãƒ¼èµ·å‹• (topic: $NTFY_TOPIC)"
    else
        log_info "ğŸ“± ntfyæœªè¨­å®šã®ãŸã‚ãƒªã‚¹ãƒŠãƒ¼ã¯ã‚¹ã‚­ãƒƒãƒ—"
    fi
    echo ""

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # STEP 7: ç’°å¢ƒç¢ºèªãƒ»ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼èµ·å‹•ãƒ»å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    log_info "ğŸ” é™£å®¹ã‚’ç¢ºèªä¸­..."
    echo ""
    echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "  â”‚  ğŸ“º Tmuxé™£å®¹ (Sessions)                                  â”‚"
    echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    tmux list-sessions | sed 's/^/     /'
    echo ""
    echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "  â”‚  ğŸ“‹ å¸ƒé™£å›³ (Formation)                                   â”‚"
    echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
    echo "     ã€shogun-teamsã‚»ãƒƒã‚·ãƒ§ãƒ³ã€‘å°†è»ã®æœ¬é™£"
    echo "     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "     â”‚  Pane 0: å°†è» (SHOGUN)      â”‚  â† ç·å¤§å°†ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±æ‹¬"
    echo "     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
    echo "     ã€multiagent-teamsã‚»ãƒƒã‚·ãƒ§ãƒ³ã€‘å®¶è€ãƒ»è¶³è»½ãƒ»è»å¸«ã®é™£ï¼ˆ3x3 = 9ãƒšã‚¤ãƒ³ï¼‰"
    echo "     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "     â”‚  karo   â”‚ashigaru3â”‚ashigaru6â”‚"
    echo "     â”‚  (å®¶è€) â”‚ (è¶³è»½3) â”‚ (è¶³è»½6) â”‚"
    echo "     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "     â”‚ashigaru1â”‚ashigaru4â”‚ashigaru7â”‚"
    echo "     â”‚ (è¶³è»½1) â”‚ (è¶³è»½4) â”‚ (è¶³è»½7) â”‚"
    echo "     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "     â”‚ashigaru2â”‚ashigaru5â”‚ gunshi  â”‚"
    echo "     â”‚ (è¶³è»½2) â”‚ (è¶³è»½5) â”‚ (è»å¸«)  â”‚"
    echo "     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""

    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘  ğŸ¯ å‡ºé™£æº–å‚™å®Œäº†ï¼å¤©ä¸‹å¸ƒæ­¦ï¼                             â•‘"
    echo "  â•‘  ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹ + mailbox + inbox_watcher ã§çµ±ç‡           â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # â”€â”€â”€ åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’èµ·å‹• â”€â”€â”€
    log_info "ğŸ–¥ï¸  ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’èµ·å‹•ä¸­..."
    _viewer_opened=false

    # iTerm2 ãŒåˆ©ç”¨å¯èƒ½ãªã‚‰å„ªå…ˆä½¿ç”¨
    if [ -d "/Applications/iTerm.app" ] || pgrep -x "iTerm2" >/dev/null 2>&1; then
        osascript -e "
            tell application \"iTerm\"
                create window with default profile command \"tmux attach-session -t multiagent-teams\"
                activate
            end tell
        " 2>/dev/null && _viewer_opened=true
    fi

    # iTerm2 ã§é–‹ã‘ãªã‹ã£ãŸå ´åˆã¯ Terminal.app ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if [ "$_viewer_opened" = false ]; then
        osascript -e "
            tell application \"Terminal\"
                do script \"tmux attach-session -t multiagent-teams\"
                activate
            end tell
        " 2>/dev/null && _viewer_opened=true
    fi

    if [ "$_viewer_opened" = true ]; then
        log_success "  â””â”€ ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•å®Œäº†"
    else
        log_info "  âš   ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ"
        echo "  æ‰‹å‹•ã§ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã‚’èµ·å‹•: tmux attach-session -t multiagent-teams"
    fi
    echo ""

    echo "  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   å¤©ä¸‹å¸ƒæ­¦ï¼å‹åˆ©ã‚’æ´ã‚ï¼ (Tenka Fubu! Seize victory!)"
    echo "  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # â”€â”€â”€ å°†è»ã®æœ¬é™£ã«ã‚¢ã‚¿ãƒƒãƒ â”€â”€â”€
    # ãƒã‚¹ãƒˆ tmux ã‚’è¨±å¯
    unset TMUX
    exec tmux attach-session -t shogun-teams
else
    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã¿ãƒ¢ãƒ¼ãƒ‰
    PANE_BASE=$(tmux show-options -gv pane-base-index 2>/dev/null || echo 0)
    log_info "ğŸ“Š ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®ã¿ãƒ¢ãƒ¼ãƒ‰: Claude Code ã¯æœªèµ·å‹•ã§ã™"
    echo ""
    echo "  æ‰‹å‹•ã§èµ·å‹•ã™ã‚‹ã«ã¯:"
    echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "  â”‚  # å°†è»ã‚’å¬å–š                                            â”‚"
    echo "  â”‚  tmux send-keys -t shogun-teams:main \                   â”‚"
    echo "  â”‚    'claude --dangerously-skip-permissions' Enter         â”‚"
    echo "  â”‚                                                          â”‚"
    echo "  â”‚  # å®¶è€ãƒ»è¶³è»½ã‚’ä¸€æ–‰å¬å–š                                  â”‚"
    printf "  â”‚  %-56sâ”‚\n" "for p in \$(seq ${PANE_BASE} $((PANE_BASE+8))); do"
    printf "  â”‚  %-56sâ”‚\n" "    tmux send-keys -t multiagent-teams:agents.\$p \\"
    printf "  â”‚  %-56sâ”‚\n" "    'claude --dangerously-skip-permissions' Enter"
    printf "  â”‚  %-56sâ”‚\n" "done"
    echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""

    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘  ğŸ¯ å‡ºé™£æº–å‚™å®Œäº†ï¼å¤©ä¸‹å¸ƒæ­¦ï¼                             â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
fi
